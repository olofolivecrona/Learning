<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daytrader</title>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f0;
      font-family: Arial, sans-serif;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .bill-timer {
      font-size: 20px;
      font-weight: 700;
      color: #333333;
    }

    .box {
      width: 420px;
      height: 260px;
      background: #ffffff;
      border: 1px solid #d9d9d9;
      padding: 12px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #333333;
    }

    .stat {
      display: flex;
      gap: 6px;
      align-items: baseline;
    }

    .stat-label {
      font-weight: 600;
    }

    .stat-value {
      font-weight: 700;
    }

    .price-up {
      color: #28a745;
    }

    .price-down {
      color: #dc3545;
    }

    .price-flat {
      color: #333333;
    }

    .chart {
      width: 100%;
      height: calc(100% - 28px);
      display: block;
    }

    .buttons {
      display: flex;
      gap: 12px;
    }

    .button-column {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    button {
      border: none;
      color: #ffffff;
      font-size: 16px;
      padding: 10px 24px;
      cursor: pointer;
      border-radius: 4px;
      text-transform: lowercase;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .buy {
      background: #28a745;
    }

    .sell {
      background: #dc3545;
    }

    .crash-banner {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      font-size: 72px;
      font-weight: 800;
      color: #dc3545;
      text-shadow: 0 0 14px rgba(220, 53, 69, 0.7);
      z-index: 1000;
      animation: crash-flash 0.35s steps(1, end) infinite;
    }

    .crash-banner.active {
      display: flex;
    }

    .surge-banner {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      font-size: 72px;
      font-weight: 800;
      color: #28a745;
      text-shadow: 0 0 14px rgba(40, 167, 69, 0.7);
      z-index: 999;
      animation: surge-flash 0.35s steps(1, end) infinite;
    }

    .surge-banner.active {
      display: flex;
    }

    .due-banner {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      font-size: 62px;
      font-weight: 800;
      color: #ff9800;
      text-shadow: 0 0 14px rgba(255, 152, 0, 0.7);
      z-index: 1002;
      text-transform: uppercase;
      text-align: center;
      width: 100vw;
      padding: 0 24px;
      box-sizing: border-box;
    }

    .due-banner.active {
      display: flex;
    }

    .game-over {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 10px;
      color: #dc3545;
      background: #ffffff;
    }

    .game-over-main {
      font-size: 52px;
      font-weight: 800;
    }

    .game-over-sub {
      font-size: 42px;
      font-weight: 800;
    }

    .game-over-time {
      font-size: 28px;
      font-weight: 700;
    }

    @keyframes crash-flash {
      0%, 49% {
        opacity: 1;
      }
      50%, 100% {
        opacity: 0;
      }
    }

    @keyframes surge-flash {
      0%, 49% {
        opacity: 1;
      }
      50%, 100% {
        opacity: 0;
      }
    }

  </style>
</head>
<body>
  <div class="crash-banner" id="crash-banner">MARKET CRASH!</div>
  <div class="surge-banner" id="surge-banner">MARKET SURGE!</div>
  <div class="due-banner" id="due-banner"></div>
  <div class="container">
    <div class="bill-timer" id="bill-timer">Time until bill is due: 0</div>
    <div class="box">
      <div class="stats">
        <div class="stat">
          <span class="stat-label">cash</span>
          <span class="stat-value" id="available-to-invest">10.000</span>
        </div>
        <div class="stat">
          <span class="stat-label">price</span>
          <span class="stat-value" id="asset-price">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">shares</span>
          <span class="stat-value" id="owned-shares">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">value</span>
          <span class="stat-value" id="portfolio-value">0</span>
        </div>
      </div>
      <svg class="chart" viewBox="0 0 396 236" xmlns="http://www.w3.org/2000/svg" aria-label="Asset value chart">
        <rect x="0" y="0" width="396" height="236" fill="#ffffff" />

        <g stroke="#ebebeb" stroke-width="1">
          <line x1="0" y1="39" x2="396" y2="39" />
          <line x1="0" y1="78" x2="396" y2="78" />
          <line x1="0" y1="117" x2="396" y2="117" />
          <line x1="0" y1="156" x2="396" y2="156" />
          <line x1="0" y1="195" x2="396" y2="195" />
          <line x1="66" y1="0" x2="66" y2="236" />
          <line x1="132" y1="0" x2="132" y2="236" />
          <line x1="198" y1="0" x2="198" y2="236" />
          <line x1="264" y1="0" x2="264" y2="236" />
          <line x1="330" y1="0" x2="330" y2="236" />
        </g>

        <polyline
          id="price-line"
          fill="none"
          stroke="#2e7d32"
          stroke-width="3"
          points="0,185 30,176 60,182 90,162 120,168 150,150 180,138 210,146 240,121 270,108 300,112 330,84 360,76 396,58"
        />
      </svg>
    </div>
    <div class="buttons">
      <div class="button-column">
        <button class="buy" id="buy-button">buy 1</button>
        <button class="buy" id="buy-10-button">buy 10</button>
        <button class="buy" id="all-in-button">all in</button>
      </div>
      <div class="button-column">
        <button class="sell" id="sell-button">sell 1</button>
        <button class="sell" id="sell-10-button">sell 10</button>
        <button class="sell" id="sell-all-button">sell all</button>
      </div>
    </div>
  </div>

  <script>
    const chartWidth = 396;
    const chartHeight = 236;
    const chartPadding = 20;
    const pointCount = 40;
    const xStep = chartWidth / (pointCount - 1);
    const normalMaxMove = 0.06;
    const eventMaxMove = normalMaxMove * 3;

    const prices = [];
    let currentValue = 100;

    for (let i = 0; i < pointCount; i += 1) {
      currentValue *= 1 + (Math.random() * 2 - 1) * normalMaxMove;
      prices.push(currentValue);
    }

    const line = document.getElementById("price-line");
    const availableToInvestElement = document.getElementById("available-to-invest");
    const assetPriceElement = document.getElementById("asset-price");
    const ownedSharesElement = document.getElementById("owned-shares");
    const portfolioValueElement = document.getElementById("portfolio-value");
    const buyButton = document.getElementById("buy-button");
    const buy10Button = document.getElementById("buy-10-button");
    const allInButton = document.getElementById("all-in-button");
    const sellButton = document.getElementById("sell-button");
    const sell10Button = document.getElementById("sell-10-button");
    const sellAllButton = document.getElementById("sell-all-button");
    const crashBanner = document.getElementById("crash-banner");
    const surgeBanner = document.getElementById("surge-banner");
    const dueBanner = document.getElementById("due-banner");
    const billTimerElement = document.getElementById("bill-timer");

    let availableToInvest = 10000;
    let assetUnits = 0;
    let lastPriceDirection = 0;
    let marketCrashMode = false;
    let marketSurgeMode = false;
    let marketSurgeTarget = 100;
    let currentBill = null;
    let timeUntilBillDue = 0;
    let gameOver = false;
    let gameOverPending = false;
    let priceIntervalId = null;
    let billIntervalId = null;
    let audioContext = null;
    let crashSoundIntervalId = null;
    let surgeSoundIntervalId = null;
    const gameStartTime = Date.now();
    const epsilon = 0.000001;

    function ensureAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      if (audioContext.state === "suspended") {
        audioContext.resume();
      }
    }

    function playTone({ frequency, duration, type = "sine", volume = 0.07, sweepTo = null }) {
      if (!audioContext) {
        return;
      }

      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      const startTime = audioContext.currentTime;
      const endTime = startTime + duration;

      oscillator.type = type;
      oscillator.frequency.setValueAtTime(frequency, startTime);
      if (sweepTo !== null) {
        oscillator.frequency.exponentialRampToValueAtTime(sweepTo, endTime);
      }

      gainNode.gain.setValueAtTime(0.0001, startTime);
      gainNode.gain.exponentialRampToValueAtTime(volume, startTime + 0.01);
      gainNode.gain.exponentialRampToValueAtTime(0.0001, endTime);

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.start(startTime);
      oscillator.stop(endTime);
    }

    function startCrashSound() {
      if (crashSoundIntervalId !== null) {
        return;
      }

      ensureAudioContext();
      playTone({ frequency: 620, duration: 0.14, type: "square", volume: 0.09 });
      crashSoundIntervalId = setInterval(() => {
        playTone({ frequency: 620, duration: 0.14, type: "square", volume: 0.09 });
      }, 260);
    }

    function stopCrashSound() {
      if (crashSoundIntervalId !== null) {
        clearInterval(crashSoundIntervalId);
        crashSoundIntervalId = null;
      }
    }

    function startSurgeSound() {
      if (surgeSoundIntervalId !== null) {
        return;
      }

      ensureAudioContext();
      playTone({ frequency: 320, sweepTo: 880, duration: 0.22, type: "triangle", volume: 0.07 });
      surgeSoundIntervalId = setInterval(() => {
        playTone({ frequency: 320, sweepTo: 880, duration: 0.22, type: "triangle", volume: 0.07 });
      }, 340);
    }

    function stopSurgeSound() {
      if (surgeSoundIntervalId !== null) {
        clearInterval(surgeSoundIntervalId);
        surgeSoundIntervalId = null;
      }
    }

    function syncModeAudio() {
      if (marketCrashMode) {
        startCrashSound();
      } else {
        stopCrashSound();
      }

      if (marketSurgeMode) {
        startSurgeSound();
      } else {
        stopSurgeSound();
      }
    }

    function playDueSound(cost) {
      ensureAudioContext();

      if (cost >= 2000) {
        playTone({ frequency: 220, duration: 0.14, type: "sawtooth", volume: 0.1 });
        setTimeout(() => {
          playTone({ frequency: 180, duration: 0.16, type: "sawtooth", volume: 0.1 });
        }, 170);
        setTimeout(() => {
          playTone({ frequency: 220, duration: 0.14, type: "sawtooth", volume: 0.1 });
        }, 360);
      } else {
        playTone({ frequency: 660, duration: 0.1, type: "triangle", volume: 0.08 });
        setTimeout(() => {
          playTone({ frequency: 880, duration: 0.14, type: "triangle", volume: 0.08 });
        }, 130);
      }
    }

    function playBuySound() {
      ensureAudioContext();
      playTone({ frequency: 880, duration: 0.06, type: "triangle", volume: 0.07 });
      setTimeout(() => {
        playTone({ frequency: 1320, duration: 0.12, type: "triangle", volume: 0.09 });
      }, 70);
    }

    function playSellSound() {
      ensureAudioContext();
      playTone({ frequency: 740, duration: 0.08, type: "square", volume: 0.07 });
      setTimeout(() => {
        playTone({ frequency: 520, duration: 0.14, type: "square", volume: 0.09 });
      }, 85);
    }

    const bills = [
      { name: "alimony payment", cost: 2500 },
      { name: "electrical bill", cost: 300 },
      { name: "phone bill", cost: 180 },
      { name: "netflix subscription", cost: 100 },
      { name: "rent payment", cost: 1800 },
      { name: "internet bill", cost: 150 },
      { name: "car insurance payment", cost: 900 },
      { name: "student loan payment", cost: 1300 },
      { name: "medical bill", cost: 3200 },
      { name: "property tax installment", cost: 5000 },
    ];

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function pickNextBill() {
      currentBill = bills[getRandomInt(0, bills.length - 1)];
      timeUntilBillDue = getRandomInt(5, 20);
      renderBillTimer();
    }

    function renderBillTimer() {
      if (!currentBill) {
        return;
      }

      billTimerElement.textContent = `Time until ${currentBill.name} is due: ${timeUntilBillDue} (payment: ${formatInvestment(currentBill.cost)})`;
    }

    function showDueBanner(message) {
      dueBanner.textContent = message;
      dueBanner.classList.add("active");
      setTimeout(() => {
        dueBanner.classList.remove("active");
      }, 2000);
    }

    function triggerGameOver() {
      if (gameOver) {
        return;
      }

      gameOver = true;
      gameOverPending = false;
      clearInterval(priceIntervalId);
      clearInterval(billIntervalId);
      stopCrashSound();
      stopSurgeSound();
      const survivedSeconds = Math.floor((Date.now() - gameStartTime) / 1000);
      document.body.innerHTML = `
        <div class="game-over">
          <div class="game-over-main">INSUFFICIENT CASH!</div>
          <div class="game-over-sub">You died</div>
          <div class="game-over-time">Seconds survived: ${survivedSeconds}</div>
        </div>
      `;
    }

    function processDueBill() {
      if (!currentBill || gameOver) {
        return;
      }

      playDueSound(currentBill.cost);
      showDueBanner(`-${formatInvestment(currentBill.cost)}`);
      availableToInvest -= currentBill.cost;
      renderStats();

      if (availableToInvest < 0) {
        gameOverPending = true;
        clearInterval(priceIntervalId);
        clearInterval(billIntervalId);
        setTimeout(() => {
          triggerGameOver();
        }, 1000);
        return;
      }

      if (availableToInvest < epsilon) {
        availableToInvest = 0;
      }

      pickNextBill();
      renderStats();
    }

    function billTick() {
      if (gameOver || gameOverPending) {
        return;
      }

      timeUntilBillDue -= 1;
      if (timeUntilBillDue <= 0) {
        processDueBill();
      }
      renderBillTimer();
    }

    function getCurrentPrice() {
      return prices[prices.length - 1];
    }

    function getPortfolioValue() {
      return assetUnits * getCurrentPrice();
    }

    function formatInvestment(value) {
      const isWholeNumber = Number.isInteger(value);
      return value.toLocaleString("de-DE", {
        minimumFractionDigits: isWholeNumber ? 0 : 2,
        maximumFractionDigits: 2,
      });
    }

    function renderStats() {
      if (gameOver || gameOverPending) {
        return;
      }

      const currentPrice = getCurrentPrice();
      const portfolioValue = getPortfolioValue();

      availableToInvestElement.textContent = formatInvestment(availableToInvest);
      assetPriceElement.textContent = formatInvestment(currentPrice);
      ownedSharesElement.textContent = formatInvestment(assetUnits);
      portfolioValueElement.textContent = formatInvestment(portfolioValue);

      assetPriceElement.classList.remove("price-up", "price-down", "price-flat");
      if (lastPriceDirection > 0) {
        assetPriceElement.classList.add("price-up");
      } else if (lastPriceDirection < 0) {
        assetPriceElement.classList.add("price-down");
      } else {
        assetPriceElement.classList.add("price-flat");
      }

      buyButton.disabled = availableToInvest + epsilon < currentPrice;
      buy10Button.disabled = availableToInvest + epsilon < currentPrice * 10;
      allInButton.disabled = availableToInvest + epsilon < currentPrice;
      sellButton.disabled = assetUnits <= epsilon;
      sell10Button.disabled = assetUnits + epsilon < 10;
      sellAllButton.disabled = assetUnits <= epsilon;

      crashBanner.classList.toggle("active", marketCrashMode);
      surgeBanner.classList.toggle("active", marketSurgeMode);
      syncModeAudio();
    }

    buyButton.addEventListener("click", () => {
      ensureAudioContext();
      const currentPrice = getCurrentPrice();
      if (availableToInvest + epsilon < currentPrice) {
        return;
      }

      availableToInvest -= currentPrice;
      assetUnits += 1;
      playBuySound();

      if (availableToInvest < epsilon) {
        availableToInvest = 0;
      }

      renderStats();
    });

    buy10Button.addEventListener("click", () => {
      ensureAudioContext();
      const currentPrice = getCurrentPrice();
      const requiredAmount = currentPrice * 10;
      if (availableToInvest + epsilon < requiredAmount) {
        return;
      }

      availableToInvest -= requiredAmount;
      assetUnits += 10;
      playBuySound();

      if (availableToInvest < epsilon) {
        availableToInvest = 0;
      }

      renderStats();
    });

    allInButton.addEventListener("click", () => {
      ensureAudioContext();
      const currentPrice = getCurrentPrice();
      if (availableToInvest + epsilon < currentPrice || currentPrice <= epsilon) {
        return;
      }

      const sharesToBuy = Math.floor(availableToInvest / currentPrice);
      if (sharesToBuy <= 0) {
        return;
      }

      availableToInvest -= sharesToBuy * currentPrice;
      assetUnits += sharesToBuy;
      playBuySound();

      if (availableToInvest < epsilon) {
        availableToInvest = 0;
      }

      marketCrashMode = true;
      marketSurgeMode = false;

      renderStats();
    });

    sell10Button.addEventListener("click", () => {
      ensureAudioContext();
      if (assetUnits + epsilon < 10) {
        return;
      }

      const currentPrice = getCurrentPrice();
      assetUnits -= 10;
      availableToInvest += 10 * currentPrice;
      playSellSound();

      if (assetUnits < epsilon) {
        assetUnits = 0;
      }

      renderStats();
    });

    sellButton.addEventListener("click", () => {
      ensureAudioContext();
      if (assetUnits <= epsilon) {
        return;
      }

      const currentPrice = getCurrentPrice();
      const unitsToSell = assetUnits < 1 ? assetUnits : 1;
      assetUnits -= unitsToSell;
      availableToInvest += unitsToSell * currentPrice;
      playSellSound();

      if (assetUnits < epsilon) {
        assetUnits = 0;
      }

      renderStats();
    });

    sellAllButton.addEventListener("click", () => {
      ensureAudioContext();
      if (assetUnits <= epsilon) {
        return;
      }

      const currentPrice = getCurrentPrice();
      const unitsToSell = assetUnits;
      assetUnits = 0;
      availableToInvest += unitsToSell * currentPrice;
      playSellSound();

      marketSurgeMode = true;
      marketCrashMode = false;
      marketSurgeTarget = Math.max(100, currentPrice * 5);

      renderStats();
    });

    function redrawLine() {
      const minPrice = Math.min(...prices);
      const maxPrice = Math.max(...prices);
      const priceRange = maxPrice - minPrice || 1;
      const drawableHeight = chartHeight - chartPadding * 2;

      const points = prices
        .map((value, index) => {
          const normalized = (value - minPrice) / priceRange;
          const y = chartHeight - chartPadding - normalized * drawableHeight;
          return `${(index * xStep).toFixed(2)},${y.toFixed(2)}`;
        })
        .join(" ");
      line.setAttribute("points", points);
    }

    function tick() {
      if (gameOver) {
        return;
      }

      const lastValue = prices[prices.length - 1];
      let nextValue;

      if (marketCrashMode) {
        const moveSize = Math.random() * eventMaxMove;
        const moveDown = Math.random() < (10 / 11);
        nextValue = moveDown
          ? lastValue * (1 - moveSize)
          : lastValue * (1 + moveSize);
      } else if (marketSurgeMode) {
        const moveSize = Math.random() * eventMaxMove;
        const moveUp = Math.random() < (10 / 11);
        nextValue = moveUp
          ? lastValue * (1 + moveSize)
          : lastValue * (1 - moveSize);
      } else {
        nextValue = lastValue * (1 + (Math.random() * 2 - 1) * normalMaxMove);
      }

      if (nextValue < 10) {
        marketCrashMode = false;
      }

      if (nextValue >= marketSurgeTarget) {
        marketSurgeMode = false;
      }

      lastPriceDirection = Math.sign(nextValue - lastValue);

      prices.shift();
      prices.push(nextValue);
      renderStats();
      redrawLine();
    }

    pickNextBill();
    renderStats();
    redrawLine();
    priceIntervalId = setInterval(tick, 100);
    billIntervalId = setInterval(billTick, 1000);
  </script>
</body>
</html>
